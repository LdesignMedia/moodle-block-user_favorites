{"version":3,"file":"favorites.min.js","sources":["../src/favorites.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tested in Moodle 3.5\n *\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n *\n * @copyright 2018 MFreak.nl\n * @author    Luuk Verhoeven\n **/\n\n/* eslint no-unused-expressions: \"off\", no-console:off, no-invalid-this:\"off\",no-script-url:\"off\", block-scoped-var: \"off\" */\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/log', 'core/sortable_list'],\nfunction ($, Ajax, Notification, Log, SortableList) {\n\n    /**\n     * Opts that are possible to set.\n     *\n     * @type {{id: number, debugjs: boolean}}\n     */\n    let opts = {\n        debugjs: true, id: 0, url: '', hash: ''\n    };\n\n    /**\n     * Set options base on listed options\n     * @param {object} options\n     */\n    const setOptions = function (options) {\n        \"use strict\";\n        let key, vartype;\n        for (key in opts) {\n            if (opts.hasOwnProperty(key) && options.hasOwnProperty(key)) {\n\n                // Casting to prevent errors.\n                vartype = typeof opts[key];\n                if (vartype === \"boolean\") {\n                    opts[key] = Boolean(options[key]);\n                } else if (vartype === 'number') {\n                    opts[key] = Number(options[key]);\n                } else if (vartype === 'string') {\n                    opts[key] = String(options[key]);\n                }\n                // Skip all other types.\n            }\n        }\n    };\n\n    const attachDragDropHandlers = function () {\n        $('ol#block_user_favorites-items > li').on(SortableList.EVENTS.DRAGEND, function(evt, info) {\n            if (info.positionChanged) {\n                favoritesModule.setOrder();\n            }\n            evt.stopPropagation();\n        });\n        $('ol#block_user_favorites-items > li').on(SortableList.EVENTS.DRAGSTART, (evt, info) => {\n            setTimeout(() => {\n                $('.sortable-list-is-dragged').width(info.element.width());\n            }, 501);\n        });\n    };\n\n    const favoritesModule = {\n\n        /**\n         * Add or update a url\n         *\n         * @param {object} data\n         * @param {string} title\n         */\n        setUrl: function (data, title) {\n\n            Notification.confirm(M.util\n                    .get_string('javascript:set_title', 'block_user_favorites'),\n                '<input class=\"form-control\" id=\"favorite-url\" value=\"'\n                + title + '\">', M.util.get_string('javascript:yes', 'block_user_favorites'),\n                M.util.get_string('javascript:no', 'block_user_favorites'), function () {\n\n                    let request = Ajax.call([{\n                        methodname: 'block_user_favorites_set_url', args: {\n                            hash: data.hash, optional: {\n                                url: data.url,\n                            }, title: $('#favorite-url').val(), blockid: opts.id,\n                        }\n                    }]);\n\n                    request[0].done(function (response) {\n                        Log.log(response);\n                        favoritesModule.reload();\n                    }).fail(Notification.exception);\n                });\n        },\n\n        /**\n         * Add or update a url\n         */\n        setOrder: function () {\n            $('ol#block_user_favorites-items li').each(function (index) {\n                Ajax.call([{\n                    methodname: 'block_user_favorites_set_order', args: {\n                        hash: $(this).data('hash'), sortorder: index\n                    }\n                }]);\n            });\n        },\n\n        /**\n         * Delete a url\n         *\n         * @param {object} data\n         */\n        remove: function (data) {\n\n            let request = Ajax.call([{\n                methodname: 'block_user_favorites_delete_url', args: {\n                    hash: data.hash, blockid: opts.id,\n                }\n            }]);\n\n            request[0].done(function (response) {\n                Log.log(response);\n                favoritesModule.reload();\n            }).fail(Notification.exception);\n        },\n\n        /**\n         * Reload the block\n         */\n        reload: function () {\n\n            let request = Ajax.call([{\n                methodname: 'block_user_favorites_content', args: {\n                    url: opts.url, blockid: opts.id,\n                }\n            }]);\n\n            request[0].done(function (response) {\n                Log.log(response);\n                $('.block_user_favorites .content').html(response.content);\n                // Re-attach drag/drop callback on the new content to ensure sorting still works after content refresh\n                attachDragDropHandlers();\n            }).fail(Notification.exception);\n\n        },\n\n        /**\n         * Init event triggers.\n         */\n        init: function () {\n            Log.log('Init block_user_favorites');\n\n            $('.block_user_favorites').on('click', '#block_user_favorites_set', function () {\n\n                // Set current as favorite.\n                favoritesModule.setUrl({\n                    'hash': opts.hash, 'url': window.location.href,\n                }, $('title').text());\n\n            }).on('click', '#block_user_favorites_delete', function () {\n                // Delete current pages from favorites.\n                favoritesModule.remove({\n                    'hash': opts.hash,\n                });\n\n            }).on('click', '.fa-remove', function () {\n                // Remove a fav in the list.\n                favoritesModule.remove($(this).closest('li').data());\n\n            }).on('click', '.fa-edit', function () {\n                // Edit a fav int the list.\n                let data = $(this).parent().parent().data();\n                data.url = null;\n                favoritesModule.setUrl(data, $(this).parent().parent().find('a').text());\n            });\n            // Instantiate new SortableList component. this only needs to happen once (i.e. not on refresh again).\n            new SortableList('ol#block_user_favorites-items');\n            // Attach the drag/drop callbacks\n            attachDragDropHandlers();\n        }\n    };\n\n    return {\n        /**\n         * Init\n         *\n         * @param {object} args\n         */\n        initialise: function (args) {\n\n            // Load the args passed from PHP.\n            setOptions(args);\n\n            // Set internal debug console.\n            Log.log(opts.debugjs);\n\n            $.noConflict();\n            $(document).ready(function () {\n                Log.log('Block User Favorites v1.2');\n                favoritesModule.init();\n            });\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Log","SortableList","opts","debugjs","id","url","hash","attachDragDropHandlers","on","EVENTS","DRAGEND","evt","info","positionChanged","favoritesModule","setOrder","stopPropagation","DRAGSTART","setTimeout","width","element","setUrl","data","title","confirm","M","util","get_string","call","methodname","args","optional","val","blockid","done","response","log","reload","fail","exception","each","index","this","sortorder","remove","html","content","init","window","location","href","text","closest","parent","find","initialise","options","key","vartype","hasOwnProperty","Boolean","Number","String","setOptions","noConflict","document","ready"],"mappings":";;;;;;;;AAyBAA,wCAAO,CAAC,SAAU,YAAa,oBAAqB,WAAY,uBAChE,SAAUC,EAAGC,KAAMC,aAAcC,IAAKC,kBAO9BC,KAAO,CACPC,SAAS,EAAMC,GAAI,EAAGC,IAAK,GAAIC,KAAM,UA2BnCC,uBAAyB,WAC3BV,EAAE,sCAAsCW,GAAGP,aAAaQ,OAAOC,SAAS,SAASC,IAAKC,MAC9EA,KAAKC,iBACLC,gBAAgBC,WAEpBJ,IAAIK,qBAERnB,EAAE,sCAAsCW,GAAGP,aAAaQ,OAAOQ,WAAW,CAACN,IAAKC,QAC5EM,YAAW,KACPrB,EAAE,6BAA6BsB,MAAMP,KAAKQ,QAAQD,WACnD,SAILL,gBAAkB,CAQpBO,OAAQ,SAAUC,KAAMC,OAEpBxB,aAAayB,QAAQC,EAAEC,KACdC,WAAW,uBAAwB,wBACxC,wDACEJ,MAAQ,KAAME,EAAEC,KAAKC,WAAW,iBAAkB,wBACpDF,EAAEC,KAAKC,WAAW,gBAAiB,yBAAyB,WAE1C7B,KAAK8B,KAAK,CAAC,CACrBC,WAAY,+BAAgCC,KAAM,CAC9CxB,KAAMgB,KAAKhB,KAAMyB,SAAU,CACvB1B,IAAKiB,KAAKjB,KACXkB,MAAO1B,EAAE,iBAAiBmC,MAAOC,QAAS/B,KAAKE,OAIlD,GAAG8B,MAAK,SAAUC,UACtBnC,IAAIoC,IAAID,UACRrB,gBAAgBuB,YACjBC,KAAKvC,aAAawC,eAOjCxB,SAAU,WACNlB,EAAE,oCAAoC2C,MAAK,SAAUC,OACjD3C,KAAK8B,KAAK,CAAC,CACPC,WAAY,iCAAkCC,KAAM,CAChDxB,KAAMT,EAAE6C,MAAMpB,KAAK,QAASqB,UAAWF,cAWvDG,OAAQ,SAAUtB,MAEAxB,KAAK8B,KAAK,CAAC,CACrBC,WAAY,kCAAmCC,KAAM,CACjDxB,KAAMgB,KAAKhB,KAAM2B,QAAS/B,KAAKE,OAI/B,GAAG8B,MAAK,SAAUC,UACtBnC,IAAIoC,IAAID,UACRrB,gBAAgBuB,YACjBC,KAAKvC,aAAawC,YAMzBF,OAAQ,WAEUvC,KAAK8B,KAAK,CAAC,CACrBC,WAAY,+BAAgCC,KAAM,CAC9CzB,IAAKH,KAAKG,IAAK4B,QAAS/B,KAAKE,OAI7B,GAAG8B,MAAK,SAAUC,UACtBnC,IAAIoC,IAAID,UACRtC,EAAE,kCAAkCgD,KAAKV,SAASW,SAElDvC,4BACD+B,KAAKvC,aAAawC,YAOzBQ,KAAM,WACF/C,IAAIoC,IAAI,6BAERvC,EAAE,yBAAyBW,GAAG,QAAS,6BAA6B,WAGhEM,gBAAgBO,OAAO,MACXnB,KAAKI,SAAa0C,OAAOC,SAASC,MAC3CrD,EAAE,SAASsD,WAEf3C,GAAG,QAAS,gCAAgC,WAE3CM,gBAAgB8B,OAAO,MACX1C,KAAKI,UAGlBE,GAAG,QAAS,cAAc,WAEzBM,gBAAgB8B,OAAO/C,EAAE6C,MAAMU,QAAQ,MAAM9B,WAE9Cd,GAAG,QAAS,YAAY,eAEnBc,KAAOzB,EAAE6C,MAAMW,SAASA,SAAS/B,OACrCA,KAAKjB,IAAM,KACXS,gBAAgBO,OAAOC,KAAMzB,EAAE6C,MAAMW,SAASA,SAASC,KAAK,KAAKH,eAGjElD,aAAa,iCAEjBM,iCAID,CAMHgD,WAAY,SAAUzB,OA/JP,SAAU0B,aAErBC,IAAKC,YACJD,OAAOvD,KACJA,KAAKyD,eAAeF,MAAQD,QAAQG,eAAeF,OAGnDC,eAAiBxD,KAAKuD,KACN,YAAZC,QACAxD,KAAKuD,KAAOG,QAAQJ,QAAQC,MACT,WAAZC,QACPxD,KAAKuD,KAAOI,OAAOL,QAAQC,MACR,WAAZC,UACPxD,KAAKuD,KAAOK,OAAON,QAAQC,QAqJnCM,CAAWjC,MAGX9B,IAAIoC,IAAIlC,KAAKC,SAEbN,EAAEmE,aACFnE,EAAEoE,UAAUC,OAAM,WACdlE,IAAIoC,IAAI,6BACRtB,gBAAgBiC"}